<div *ngIf="isLoading">
  <app-loading></app-loading>
</div>
<h1 class="titulo">Complete los campos</h1>
<form [formGroup]="form" (ngSubmit)="onSubmit()" class="registro-form">
  <!-- Selector visual -->
  <div class="tipo-grid" role="radiogroup" aria-label="Tipo de registro">
    <button type="button" class="tipo-card" role="radio" [attr.aria-checked]="tipoSeleccionado === 'paciente'"
      (click)="seleccionarTipo('paciente')" [class.selected]="tipoSeleccionado === 'paciente'">
      <img src="/assets/registroPaciente.png" alt="Registro Paciente" class="tipo-img" />
      <div class="tipo-label">Paciente</div>
    </button>

    <button type="button" class="tipo-card" role="radio" [attr.aria-checked]="tipoSeleccionado === 'especialista'"
      (click)="seleccionarTipo('especialista')" [class.selected]="tipoSeleccionado === 'especialista'">
      <img src="/assets/registroEspecialista.png" alt="Registro Especialista" class="tipo-img" />
      <div class="tipo-label">Especialista</div>
    </button>

    <button *ngIf="modoAdmin" type="button" class="tipo-card" role="radio"
      [attr.aria-checked]="tipoSeleccionado === 'admin'" (click)="seleccionarTipo('admin')"
      [class.selected]="tipoSeleccionado === 'admin'">
      <img src="/assets/registroAdmin.png" alt="Registro Administrador" class="tipo-img" />
      <div class="tipo-label">Administrador</div>
    </button>
  </div>


  <!-- Campos -->
  <ng-container *ngIf="tipoSeleccionado">
    <div class="form-bloque">
      <input class="campo" id="nombre" formControlName="nombre" placeholder="Nombre" />
      <input class="campo" id="apellido" formControlName="apellido" placeholder="Apellido" />
      <input class="campo" id="edad" formControlName="edad" type="number" placeholder="Edad" />
      <input class="campo" id="dni" formControlName="dni" placeholder="DNI" />

      <input class="campo" *ngIf="tipoSeleccionado === 'paciente'" formControlName="obraSocial" placeholder="Obra Social" />

      <!-- Especialidades (especialista) -->
      <div *ngIf="tipoSeleccionado === 'especialista'" class="form-bloque-especialidades">
        <details class="especialidades-details">
          <summary class="especialidades-summary">Seleccionar especialidades
            <span class="count">({{(form.get('especialidadesSeleccionadas')?.value || []).length }})</span>
          </summary>

          <div class="especialidades-list">
            <div *ngFor="let esp of especialidades" class="especialidad-item">
              <input type="checkbox" [value]="esp" (change)="toggleEspecialidad(esp, $event)"
                [checked]="form.get('especialidadesSeleccionadas')?.value?.includes(esp)" />
              {{ esp }}
            </div>

            <div class="nueva-especialidad">
              <button type="button" (click)="agregarCampoNuevaEspecialidad()"
                *ngIf="!form.get('nuevaEspecialidad')">Agregar nueva especialidad</button>

              <div *ngIf="form.get('nuevaEspecialidad')" class="nueva-especialidad-input">
                <input formControlName="nuevaEspecialidad" placeholder="Nueva especialidad..." />
                <div style="display:flex;gap:8px">
                  <button type="button" (click)="agregarNuevaEspecialidad()">Confirmar</button>
                  <button type="button" (click)="form.removeControl('nuevaEspecialidad')">Cancelar</button>
                </div>
              </div>
            </div>
          </div>
        </details>
      </div>

      <input class="campo" formControlName="mail" type="email" placeholder="Correo electr칩nico" />
      <input class="campo" formControlName="password" type="password" placeholder="Contrase침a" />

      <label *ngIf="tipoSeleccionado === 'especialista' || tipoSeleccionado === 'admin'">Imagen de perfil</label>
      <label *ngIf="tipoSeleccionado === 'paciente'">Im치genes de perfil</label>

      <div class="images-container">
        <div class="image-slot">
          <label *ngIf="!imagenPreview" class="file-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 'imagenPerfil')" />
            <span>Examinar...</span>
          </label>
          <img *ngIf="imagenPreview" [src]="imagenPreview" alt="Preview perfil" class="preview-img" />
          <button *ngIf="imagenPreview" type="button" class="btn-trash" (click)="removeImage('imagenPerfil')">游딈</button>
        </div>

        <div class="image-slot">
          <label *ngIf="tipoSeleccionado === 'paciente' && !imagenExtraPreview" class="file-label">
            <input type="file" accept="image/*" (change)="onFileSelected($event, 'imagenPerfilExtra')" />
            <span>Examinar...</span>
          </label>
          <img *ngIf="imagenExtraPreview && tipoSeleccionado === 'paciente'" [src]="imagenExtraPreview" alt="Preview adicional" class="preview-img" />
          <button *ngIf="imagenExtraPreview && tipoSeleccionado === 'paciente'" type="button" class="btn-trash" (click)="removeImage('imagenPerfilExtra')">游딈</button>
        </div>
      </div>
    </div>
    
    <!-- Bot칩n Admin para activar/desactivar -->
    <button type="button" appCaptchaAdmin 
            [esAdmin]="modoAdmin" 
            [captchaActivo]="captchaHabilitado" 
            (captchaState)="manejarCaptcha($event)"></button>

    <!-- Contenedor del Captcha (IMPORTANTE: *ngIf controla si existe en el DOM) -->
    <div *ngIf="captchaHabilitado" id="captcha-container" class="captcha-wrapper"></div>
    
    <button type="submit" class="btn-primary" [disabled]="isLoading">Registrar</button>
  </ng-container>
</form>

<button type="button" class="btn-volverAUsuarios" *ngIf="modoAdmin" (click)="cancelar()">
  Volver a la lista de usuarios
</button>
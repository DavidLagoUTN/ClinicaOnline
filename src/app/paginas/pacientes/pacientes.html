<app-navbar></app-navbar>

<h1 class="titulo">Pacientes atendidos</h1>

<div class="app-container">
    <div class="tarjeta-mis-turnos">

        <!-- Filtro simple -->
        <div class="header-controls">
            <div class="filtros">
                <input #filterInput type="text" class="input-buscador"
                    placeholder="Filtrar por nombre, apellido, DNI u obra social"
                    (input)="filtrarPacientes(obtenerValorInput($event))" />
                <button class="btn-ghost" (click)="limpiarFiltro(filterInput)">Limpiar</button>
            </div>
        </div>

        <!-- Resumen -->
        <div class="resumen">
            <h2>Pacientes atendidos</h2>
            <div class="muted">Total: <strong>{{ filteredPatients.length }}</strong></div>
        </div>

        <!-- Estados -->
        <div *ngIf="loading" class="empty">Cargando pacientes...</div>
        <div *ngIf="!loading && !error && filteredPatients.length === 0" class="empty">No hay pacientes atendidos aún
        </div>
        <div *ngIf="!loading && error" class="empty">{{ error }}</div>

        <!-- Lista de cards -->
        <div class="turnos-list" *ngIf="!loading && !error">
            <div *ngFor="let p of filteredPatients; trackBy: trackByUid" class="turno-card paciente-card">
                <div class="turno-left">
                    <div class="avatar-mini">
                        <img [src]="p.imagenPerfil || p.imagenPerfilExtra || defaultAvatar"
                            [alt]="p.nombre || 'Avatar'" />
                    </div>
                </div>

                <div class="turno-body">
                    <div class="fila-1">
                        <div class="persona">
                            <strong>{{ p.nombre || '—' }} {{ p.apellido || '' }}</strong>
                        </div>

                        <div class="nota">
                            <div>{{ p.turnosAtendidos }} turno(s) atendido(s)</div>
                        </div>
                    </div>

                    <!-- Datos: Edad / DNI / Obra Social -->
                    <div class="fila-2 datos-turno">
                        <div class="dato-row">
                            <div class="dato">
                                <span class="muted">Edad:</span>
                                <strong>{{ p.edad ?? '—' }}</strong>
                            </div>
                        </div>

                        <div class="dato-row">
                            <div class="dato">
                                <span class="muted">DNI:</span>
                                <strong>{{ p.dni || '—' }}</strong>
                            </div>
                        </div>

                        <div class="dato-row">
                            <div class="dato">
                                <span class="muted">Obra social:</span>
                                <strong>{{ p.obraSocial || '—' }}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Últimos 3 turnos -->
                    <div class="fila-2 datos-turno" style="margin-top:8px;">
                        <div style="width:100%;">
                            <div class="muted" style="font-weight:600; margin-bottom:6px;">Últimos turnos:</div>

                            <div class="ultima-list-inline">
                                <ng-container *ngIf="p.ultimosTurnos && p.ultimosTurnos.length > 0; else sinTurnos">
                                    <div *ngFor="let t of p.ultimosTurnos" class="ultimo-turno-inline"
                                        title="{{ t.fecha }} · {{ t.hora }} - {{ t.especialidad || '—' }}">
                                        <div class="turno-left-inline">{{ t.fecha }} · {{ t.hora }}</div>
                                        <div class="turno-sep"> - </div>
                                        <div class="turno-right-inline">{{ t.especialidad || '—' }}</div>
                                    </div>
                                </ng-container>

                                <ng-template #sinTurnos>
                                    <div class="muted">No hay turnos registrados</div>
                                </ng-template>
                            </div>
                        </div>
                    </div>


                    <!-- Panel expandible: historia clínica -->
                    <div class="resena-toggle" style="margin-top:8px;">
                        <button class="btn-ghost" (click)="togglePaciente(p)">
                            {{ expandedPacienteUid === p.uid ? 'Ocultar historia clínica' : 'Ver historia clínica' }}
                        </button>
                    </div>

                    <div class="resena-panel" [class.open]="expandedPacienteUid === p.uid">
                        <div *ngIf="expandedPacienteUid === p.uid">

                            <div *ngIf="loadingHistoriaMap[p.uid]" class="muted">Cargando historia clínica...</div>

                            <div *ngIf="!loadingHistoriaMap[p.uid] && (!historiasMap[p.uid] || historiasMap[p.uid]?.length === 0)"
                                class="muted" style="text-align:center; padding:10px;">
                                No hay registros en la historia clínica.
                            </div>

                            <!-- Lista de Historias Clínicas (Array) -->
                            <ng-container *ngIf="historiasMap[p.uid] && historiasMap[p.uid]?.length! > 0">
                                <div *ngFor="let h of historiasMap[p.uid]" class="historia-card">
                                    
                                    <!-- Encabezado -->
                                    <div class="historia-header">
                                        <div style="display:flex; flex-direction: column;">
                                            <strong class="historia-title">{{ h.fechaStr }}</strong>
                                            <span class="historia-meta" style="margin-top: 4px;">Atendido por: <strong>{{ h.especialista }}</strong></span>
                                        </div>
                                        <div class="historia-meta" style="text-align: right;">
                                            <span style="display: block; font-size: 0.75rem; color: #104ea7; text-transform: uppercase;">Especialidad</span>
                                            <strong style="color: #083049;">{{ h.especialidad }}</strong>
                                        </div>
                                    </div>

                                    <!-- Datos Estáticos -->
                                    <div class="historia-datos-fijos">
                                        <div class="dato-box">
                                            <div class="label">Peso</div>
                                            <div class="value">{{ h.peso ?? '—' }} kg</div>
                                        </div>
                                        <div class="dato-box">
                                            <div class="label">Altura</div>
                                            <div class="value">{{ h.altura ?? '—' }} cm</div>
                                        </div>
                                        <div class="dato-box">
                                            <div class="label">Temp</div>
                                            <div class="value">{{ h.temperatura ?? '—' }} °C</div>
                                        </div>
                                        <div class="dato-box">
                                            <div class="label">Presión</div>
                                            <div class="value">{{ h.presion ?? '—' }}</div>
                                        </div>
                                    </div>

                                    <!-- Datos Clínicos -->
                                    <div *ngIf="(h.dinamicos || []).length > 0" class="historia-seccion">
                                        <span class="seccion-titulo">Datos Clínicos</span>
                                        <div class="items-list">
                                            <div *ngFor="let d of h.dinamicos" class="item-dato">
                                                <strong>{{ d.clave }}:</strong> {{ formatearValorDinamico(d.valor) }}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Datos Opcionales -->
                                    <div *ngIf="(h.opcionales || []).length > 0" class="historia-seccion">
                                        <span class="seccion-titulo">Datos Opcionales</span>
                                        <div class="items-list">
                                            <div *ngFor="let o of h.opcionales" class="item-dato">
                                                <strong>{{ o.clave }}:</strong> {{ formatearValorDinamico(o.valor) }}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Diagnóstico -->
                                    <div *ngIf="h.diagnostico" class="historia-seccion">
                                        <span class="seccion-titulo">Diagnóstico</span>
                                        <div class="texto-bloque">{{ h.diagnostico }}</div>
                                    </div>

                                    <!-- Reseña -->
                                    <div *ngIf="h.resenia" class="historia-seccion">
                                        <span class="seccion-titulo">Reseña</span>
                                        <div class="texto-bloque">{{ h.resenia }}</div>
                                    </div>

                                </div>
                            </ng-container>

                        </div>
                    </div>

                </div>

            </div>
        </div>

    </div>
</div>
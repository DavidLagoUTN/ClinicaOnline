rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- 1. Reglas Específicas (Prioridad) ---

    // Especialidades (Tu regla original: lectura pública, escritura controlada)
    match /especialidades/{docId} {
      allow list, get: if true;
      allow create: if request.resource.data.nombre is string
                    && request.resource.data.nombre.size() > 2
                    && request.resource.data.nombre.size() <= 80
                    && request.resource.data.createdAt is timestamp;
      allow update, delete: if false;
    }

    // --- 2. Colecciones del Sistema (Necesarias para la App) ---

    // Turnos: Vital para los gráficos y el flujo principal
    match /turnos/{docId} {
      allow read, write: if request.auth != null;
    }

    // Usuarios: Necesario para el login, perfiles y listados de admin
    match /usuarios/{userId} {
      allow read, write: if request.auth != null;
    }

    // Logs de Ingresos: Necesario para el reporte de auditoría (Sprint 4)
    match /log_ingresos/{docId} {
      allow read, create: if request.auth != null;
    }

    // Historias Clínicas
    match /historias_clinicas/{docId} {
      allow read, write: if request.auth != null;
    }

    // --- 3. Regla General (Fallback) ---
    // Permite acceso a cualquier otra colección futura si estás logueado
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}